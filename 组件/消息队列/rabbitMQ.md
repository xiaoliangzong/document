## MQ

MQ (message Queue) 消息队列，本质是个队列，FIFO 先入先出，只不过是在队列中存放的内容是 message 而已，还是一种跨进程的通信机制，用于上下游传递信息。在互联网架构中，MQ 是一种非常常
见的上下游的消息通信服务。使用了 MQ 之后，消息发送上游只需要依赖 MQ，不用依赖其他服务。

**优点**

- **应用解耦**：多个系统间的通信
- **流量削峰**：每秒中由上万个请求写入 MQ 中，然后消费者慢慢去消费，不会使系统因为并发请求数量大，导致崩溃
- **异步处理**：用户调用一个接口的时候，可能该接口调用了别的方法。例如：用户注册的时候，后台可能需要调用：查询数据库，插入数据库，发送邮件，发送用户指南等等...但是用户可能并不需要后台将所有的任务执行完毕，那么此时在插入数据库后将其他任务加入 mq 队列，用户就能很快得到注册成功的响应而去做一些别的事情。mq 的机制又能保证最终的一致性，所以使用起来很安全很稳定。

**缺点**

- **增加了复杂度、降低了可用性**

本来系统之间可以直接通过调用接口就可以，但是引入 mq 会导致系统复杂性大大增加，并且如果 mq 挂掉，则系统间的通信中断，会导致整个系统全部挂掉

- **存在一致性问题**

A 系统处理完了发送消息给 mq 后直接返回成功，用户会认为这个请求成功，但是其他系统消费消息时，系统出现问题，导致数据丢失，最后就会发生数据不一致等问题

**分类**

| 特性                     | ActiveMQ                                                                                                                                                                                                                                                 | RabbitMQ                                                                                                                                                                                             | RocketMQ                                                                                                                                                                                                                            | Kafka                                                                                                                                                                                                                                                           |
| ------------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 单机吞吐量               | 万级                                                                                                                                                                                                                                                     | 万级                                                                                                                                                                                                 | 10 万级，RocketMQ 也是可以支撑高吞吐的一种 MQ                                                                                                                                                                                       | 10 万级，这是 kafaka 最大的优点，就是吞吐量高，一般配合大数据类的系统来进行实时数据计算，日志采集等场景                                                                                                                                                         |
| 时效性                   | ms 级                                                                                                                                                                                                                                                    | 微秒级，延迟最低                                                                                                                                                                                     | ms 级                                                                                                                                                                                                                               | 延迟在 ms 级内                                                                                                                                                                                                                                                  |
| 可用性                   | 高，基于主从架构实现的高可用性                                                                                                                                                                                                                           | 高，基于主从架构实现的高可用性                                                                                                                                                                       | 非常高，分布式架构                                                                                                                                                                                                                  | 非常高，kafka 是分布式的，一个数据多个副本，少数机器宕机，不会丢失数据，不会导致不可用                                                                                                                                                                          |
| 消息可靠性               | 有较低的概率丢失数据                                                                                                                                                                                                                                     |                                                                                                                                                                                                      | 经过参数优化配置，可以做到 0 丢失                                                                                                                                                                                                   | 经过参数优化配置，可以做到 0 丢失                                                                                                                                                                                                                               |
| topic 数量对吞吐量的影响 |                                                                                                                                                                                                                                                          |                                                                                                                                                                                                      | 支持 10 亿级别的消息堆积，不会因为堆积导致性能下降                                                                                                                                                                                  |                                                                                                                                                                                                                                                                 |
| 功能支持                 | MQ 领域的功能极其完备                                                                                                                                                                                                                                    | 基于 erlang 开发，所以并发能力很强，性能极其好，延时很低                                                                                                                                             | MQ 功能较为完善，还是分布式的，扩展性好                                                                                                                                                                                             | 功能较为简单，主要支持简单的 MQ 功能，在大数据领域的实时计算以及日志采集被大规模使用，是事实上的标准                                                                                                                                                            |
| 优劣势总结               | 非常成熟，功能强大，以前在业内大量的公司以及项目中都有应用，偶尔会有较低概率丢失消息，但是现在社区以及国内应用都越来越少，官方社区现在对 ActiveMQ 5.x 维护越来越少，几个月才发布一个版本而且确实主要是基于解耦和异步来用的，较少在大规模吞吐的场景中使用 | erlang 语言开发，性能极其好，延时很低；吞吐量到万级，MQ 功能比较完备而且开源提供的管理界面非常棒，用起来很好用,社区活跃度高，更新频率相当高。RabbitMQ 吞吐量会低一些，这是因为他做的实现机制比较重。 | 出自阿里巴巴的开源产品，用 java 语言实现，接口简单易用，被阿里广泛应用在订单，交易，充值，流计算，消息推送，日志流处理等场景，可以做到大规模吞吐，性能也非常好，分布式扩展也很方便，社区维护还可以，还可以支撑大规模的 topic 数量。 | kafka 的特点其实很明显，就是仅仅提供较少的核心功能，但是提供超高的吞吐量，ms 级的延迟，极高的可用性以及可靠性，而且分布式可以任意扩展同时 kafka 最好是支撑较少的 topic 数量即可，保证其超高吞吐量，目前已经被 LinkedIn，Uber, Twitter, Netflix 等大公司所采纳。 |

**MQ 的选择**

1. Kafka

Kafka 主要特点是基于 Pull 的模式来处理消息消费，追求高吞吐量，一开始的目的就是用于日志收集和传输，适合产生大量数据的互联网服务的数据收集业务。大型公司建议可以选用，如果有日志采集功能，肯定是首选 kafka 了

2. RocketMQ

天生为金融互联网领域而生，对于可靠性要求很高的场景，尤其是电商里面的订单扣款，以及业务削峰，在大量交易涌入时，后端可能无法及时处理的情况。RoketMQ 在稳定性上可能更值得信赖，这些业务场景在阿里双 11 已经经历了多次考验，如果你的业务有上述并发场景，建议可以选择 RocketMQ。

3. RabbitMQ

结合 erlang 语言本身的并发优势，性能好时效性微秒级，社区活跃度也比较高，管理界面用起来十分方便，如果你的数据量没有那么大，中小型公司优先选择功能比较完备的 RabbitMQ。

## RabbitMQ

### 1. windows 安装

- 安装语言 erlang
- 安装 mq
- 安装插件 rabbitmq-plugins.bat enable rabbitmq_management

### 2. 操作命令

- rabbitmqctl status 查看状态
- rabbitmq-server.bat 启动命令
