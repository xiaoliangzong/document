# JMeter

## 简介

[JMeter (https://jmeter.apache.org/)](https://jmeter.apache.org/) 是一个纯 Java 编写的开源软件，主要用于进行性能测试和功能测试。它支持测试的应用/服务/协议包括 Web (HTTP, HTTPS)、SOAP/REST Webservices、FTP、Database via JDBC 等。我们最常使用的是 HTTP 和 HTTPS 协议。

## 安装

由于 Jemter 是基于 java 语言开发的，所以使用 Jemter 需要安装 JDK。（Jemter5.0 版本要求 JDK 版本为 1.8 或 1.9，一般安装 JDK1.8）。

[下载地址：https://jmeter.apache.org/download_jmeter.cgi](https://jmeter.apache.org/download_jmeter.cgi)

官网提供有二进制包和源码包两种形式。

- 二进制包：包含了已经编译好的可执行文件、相关的库文件以及文档等，是可以直接使用的版本。
- 源码包：包含了 JMeter 的所有源代码、构建脚本以及相关的开发文档等。它是 JMeter 的原始代码形式，方便开发人员对其进行二次开发、扩展功能或进行代码研究。

二进制包直接解压便可使用，推荐配置环境变量。

Jemter 切换中文环境，在上方导航栏，选择 Options -> Choose Language -> Chinese(Simplified)，将语言切换为中文

## 主要组件

1. 线程组（Thread Group）：

   - 线程数（Number of Threads）：模拟的用户数量。
   - Ramp-Up 时间（Ramp-Up Period）：设置的虚拟用户数需要多长时间全部启动。如果线程数为 5，准备时长为 1，那么需要 1 秒钟启动 5 个线程，也就是每秒钟启动 5 个线程。
   - 循环次数（Loop Count）：每个线程发送请求的次数。如果线程数为 100，循环次数为 10，那么每个线程发送 10 次请求。总请求数为 100\*10=1000 。若勾选“永远”，则所有线程会一直发送请求，直到选择停止运行脚本。
   - Same user on each iteration：用于控制每次迭代是否使用相同的线程（即用户）。当该参数被勾选时，JMeter 在每次迭代时都会使用相同的线程来模拟用户行为。在连续的请求中，会保持相同的用户身份（如会话、Cookie 等）。
   - 调度器：设置线程组启动的开始时间和结束时间(配置调度器时，需勾选循环次数为永远)。

     - 启动延迟（秒）：测试延迟的启动时间
     - 持续时间（秒）：测试持续的时间

2. 取样器（Sampler）：

   - 用于向服务器发送请求，如 HTTP 请求、JDBC 请求等。
   - 在线程组下添加取样器，配置请求的 URL、方法、参数等。

3. 逻辑控制器（Logical Controller）：

   - 用于控制测试的执行逻辑，如循环、条件判断等。
   - 常见的逻辑控制器有 If 控制器、循环控制器等。

4. 前置处理器（PreProcessor）和后置处理器（PostProcessor）：

   - 前置处理器在请求发送前执行操作，如设置请求头、生成数据等。
   - 后置处理器在请求发送后执行操作，如处理响应数据、提取需要的值等。

5. 断言（Assertion）：

   - 用于验证响应是否符合预期。
   - 可以使用正则表达式、XPath、JSON Path 等方式进行断言。

6. 监听器（Listener）：

   - 用于展示测试结果，如查看结果树、聚合报告等。
   - 在测试计划或线程组下添加监听器，以查看和分析测试结果。

## 高级功能

1. 参数化：

   - 使用 CSV Data Set Config 等方式实现参数化，方便进行批量测试。
   - 在测试计划中配置 CSV 文件路径和变量名，然后在取样器中使用这些变量。

2. 定时器（Timer）：

   - 用于控制请求的发送频率。
   - 在线程组或取样器下添加定时器，配置延迟时间和执行时间等参数。

3. 分布式测试：

   - 通过配置多个 Jmeter 实例，实现分布式测试，提高测试效率。
   - 需要设置主节点和从节点，以及配置相关的测试计划和数据文件等。

## 使用

1. 添加线程组

右键点击“Test Plan” -> 添加 -> 线程（用户） -> 线程组

2. 添加 HTTP 请求

JMeter 的 HTTP 请求是性能测试中常用的功能，用于模拟用户向服务器发送 HTTP 请求并获取响应。

右键点击线程组 -> 添加 -> 取样器 -> HTTP 请求，添加一个 HTTP 请求

3. 添加查看结果树

JMeter 的结果查看树用于查看和分析 HTTP 请求的响应结果。

右键点击线程组 -> 添加 -> 监听器 -> 查看结果树，添加一个查看结果树

4. 添加聚合报告

聚合报告是 JMeter 中用于汇总和分析测试结果的工具。它提供了关于测试运行的各种性能指标，如响应时间、吞吐量、错误率等。进入聚合报告进行测试前，需要点击上方的扫把按钮清楚之前的调试结果。

右键点击 线程组 -> 添加 -> 监听器 -> 聚合报告，用以存放性能测试报告

一般情况下，性能测试中需要重点关注的数据有请求数、平均响应时间、最小响应时间、最大响应时间、吞吐量和错误率

参数说明：

- Label：每个 JMeter 的元素（如 HTTP 请求）都有一个 Name 属性，Label 显示的就是 Name 属性的值
- #样本：发送请求的总数量。表示这次测试中一共发出了多少个请求。如模拟 100 个线程数（即 100 个用户），每个线程迭代 10 次，这里就显示 100\*10 = 1000
- 平均值：所有请求的响应时间的算术平均值。计算方法是将所有请求的响应时间相加，然后除以请求的总数量。平均值是衡量系统性能的一个重要指标，它可以让你大致了解系统响应的平均快慢程度。
- 中位数：所有请求的响应时间按照从小到大的顺序排列，位于中间位置的数值就是中位数。如果请求数量是奇数，那么中位数就是中间的那个数；如果请求数量是偶数，中位数是中间两个数的平均值。中位数相对于平均值来说，更能抵抗极端值的影响，能更稳健地反映响应时间的集中趋势。
- 90% 百分位：有 90% 的请求响应时间低于这个值。这个指标对于衡量系统在大部分情况下的性能表现很有用，因为它关注了大多数请求的情况，而不是被少数极慢或极快的请求所影响。
- 95% 百分位：有 95% 的请求响应时间低于这个值。
- 99% 百分位：有 99% 的请求响应时间低于这个值。
- 最小值：所有请求的响应时间中的最小数值。
- 最大值：所有请求的响应时间中的最大数值。
- 异常%：请求错误率，即错误请求数/请求总数。错误率是评估系统稳定性和可靠性的关键指标，如果错误率过高，说明系统可能存在严重的问题，需要进一步分析错误的原因，如网络问题、服务器故障或者请求参数错误等。
- 吞吐量：每秒系统能够处理的请求数量，单位是请求 / 秒（requests per second）。吞吐量的计算与测试计划中的线程设置、循环次数和测试时间等因素有关。
- 接收 KB/Sec：每秒从服务器端接收到的数据量（以千字节为单位）。这些指标对于分析系统的网络负载很有用，例如，如果接收的数据量过大，可能会导致网络拥塞或者服务器资源紧张。
- 发送 KB/Sec：每秒发送到服务器端的数据量（以千字节为单位）。

5. 添加用户自定义变量

用户自定义变量作为存储和管理测试期间需要的值，这些变量可以在测试计划中的任何地方引用。在 HTTP 请求中使用该参数，格式为 ${变量名称}

右键点击 线程组 -> 添加 -> 配置元件 -> 用户定义的变量，以添加用户自定义变量

6. 添加断言

JMeter 中，断言用于验证测试结果是否符合预期。

在 HTTP 请求中添加响应断言：右键点击 HTTP 请求 -> 添加 -> 断言 -> 响应断言

7. 添加断言结果

为查看断言的结果，在 HTTP 请求中添加断言结果：右键点击 HTTP 请求 -> 添加 -> 监听器 -> 断言结果

## 结果分析

1. 性能瓶颈定位：

如果平均值或者 90% 百分位响应时间过长，同时吞吐量较低，可能表示系统存在性能瓶颈。这时候可以检查服务器的资源使用情况（如 CPU、内存、磁盘 I/O 等），或者查看请求的具体内容，判断是否是因为某些复杂的业务逻辑导致响应变慢。

2. 系统稳定性评估：

错误率是评估系统稳定性的关键指标。如果错误率在测试过程中持续上升，或者高于可接受的范围（如 5% 以上），需要重点关注。可能是服务器负载过高导致部分请求无法正常响应，或者是网络不稳定等原因造成的。可以结合系统日志和网络监控工具进一步分析原因。

3. 系统容量规划：

通过观察吞吐量指标，可以了解系统当前的处理能力。如果在增加用户负载（如增加线程组中的线程数）的情况下，吞吐量逐渐下降，或者响应时间急剧上升，说明系统可能已经接近其容量极限。这对于规划系统的扩展和优化很有帮助，例如，决定是否需要增加服务器资源或者优化系统架构。
