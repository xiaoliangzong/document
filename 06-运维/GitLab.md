# GitLab

官网： https://about.gitlab.com/

## 1. 简介

GitLab 是一个用于仓库管理系统的开源项目，使用 Git 作为代码管理工具，并在此基础上搭建起来的 web 服务。

GitLab 和 GitHub 一样属于第三方基于 Git 开发的作品，免费且开源（基于 MIT 协议），与 Github 类似，可以注册用户，任意提交你的代码，添加 SSHKey 等等。不同的是，GitLab 是可以部署到自己的服务器上，数据库等一切信息都掌握在自己手上，适合团队内部协作开发。

## 2. 安装

## 3. 添加组、创建用户、创建项目

1）创建组

使用管理员 root 创建组，一个组里面可以有多个项目分支，可以将开发添加到组里面进行设置权限，不同的组就是公司不同的开发项目或者服务模块，不同的组添加不同的开发即可实现对开发设置权限的管理

2）创建用户

创建用户的时候，可以选择 Access level，其中有两个类型： Regular 或 Admin 。

- Regular：普通用户，只能访问属于他的组和项目。
- admin：管理员，可以访问所有组和项目。

3）将用户添加到组中

选择某个用户组，进行 Members 管理组的成员，并设置权限。

Gitlab 用户在组里面有 5 种不同权限：

1. Guest：访客，可以创建 issue、发表评论，不能读写版本库
2. Reporter：报告者，可以克隆代码，不能提交，QA、PM 可以赋予这个权限
3. Developer：开发者，可以克隆代码、开发、提交、push，普通开发可以赋予这个权限
4. Maintainer：管理者，可以创建项目、添加 tag、保护分支、添加项目成员、编辑项目，核心开发可以赋予这个权限
5. Owner：所有者，最高权限，可以设置项目访问权限 - Visibility Level、删除项目、迁移项目、管理组成员，开发组组长可以赋予这个权限

4）在用户组中创建项目

以刚才创建的新用户身份登录到 Gitlab，然后在用户组中创建新的项目

## 2. 查询项目代码存在位置

```sh
# 1. 查看项目id，登录gitlab后台找到对应项目id
# 2. 项目id转字符串
echo -n 25 | sha256sum
# 3. 找到gitlab中项目存放的位置
find / -name b7a56873cd771f2c446d369b649430b65a756ba278ff97ec81bb6f55b2e73569.git
```

## Gitlab 利用 Hook 锁定文件不被修改

几种常见的方案：

1. 在客户端做 git hook，主要是用 pre-commit 这个钩子。前端项目中常见的 husky 就是基于此实现的。但缺点也很明显，就是在本地把这个钩子删了、或者 git commit --no-verify 就绕开了。不过小团队、大家约定好的话这种方案是最方便的。
2. 在服务端做 git hook，主要是用 pre-receive 这个钩子。
3. 不限制 push、但通过其他方式限制。比如可以通过 CI 限制，例如在 forking-workflow 模式中设置在 Merge 时自动执行一个 Actions 来执行 Lint，对于不合格的 Merge Request 直接关闭掉不允许合并，以变相到达不合格代码进入主干的目的。

其中 1、2 两点跟 GitLab 无关，需要的都是写 Shell 脚本而已。第 3 种可以在 GitLab 用图形化方式设置。小团队的第一种用的比较多；大团队这一步骤大多是跟 CI/CD 工作流紧密结合的。

### Git 钩子

服务端钩子会接受到三个参数：

    - 被推送的引用的名字。更新的引用名称
    - 推送前分支的修订版本（revision）。引用中存放的旧的对象名称
    - 用户准备推送的修订版本（revision）。引用中存放的新的对象名称

pre-receive

处理来自客户端的推送操作时，最先被调用的脚本是 pre-receive。 它从标准输入获取一系列被推送的引用。如果它以非零值退出，所有的推送内容都不会被接受。 你可以用这个钩子阻止对引用进行非快进（non-fast-forward）的更新，或者对该推送所修改的所有引用和文件进行访问控制。

update

update 脚本和 pre-receive 脚本十分类似，不同之处在于它会为每一个准备更新的分支各运行一次。 假如推送者同时向多个分支推送内容，pre-receive 只运行一次，相比之下 update 则会为每一个被推送的分支各运行一次。 它不会从标准输入读取内容，而是接受三个参数：引用的名字（分支），推送前的引用指向的内容的 SHA-1 值，以及用户准备推送的内容的 SHA-1 值。 如果 update 脚本以非零值退出，只有相应的那一个引用会被拒绝；其余的依然会被更新。

post-receive

post-receive 挂钩在整个过程完结以后运行，可以用来更新其他系统服务或者通知用户。 它接受与 pre-receive 相同的标准输入数据。 它的用途包括给某个邮件列表发信，通知持续集成（continous integration）的服务器， 或者更新问题追踪系统（ticket-tracking system） —— 甚至可以通过分析提交信息来决定某个问题（ticket）是否应该被开启，修改或者关闭。 该脚本无法终止推送进程，不过客户端在它结束运行之前将保持连接状态， 所以如果你想做其他操作需谨慎使用它，因为它将耗费你很长的一段时间。

## gitlab 集成 cicd

1. 仓库根目录 创建一个.gitlab-ci.yml 文件
2. 安装 gitlab-runner
